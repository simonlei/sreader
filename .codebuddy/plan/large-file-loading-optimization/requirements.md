# 需求文档

## 引言

SReader 是一个 Android 文本阅读器应用，当前在打开大文件（如超过几 MB 的小说文件）时，加载速度较慢，用户体验不佳。

通过对现有代码的分析，发现以下主要性能瓶颈：

1. **文件读取**（`FileLoader`）：使用 `readBytes()` 一次性将整个文件读入内存为字节数组，再转为 `String`，对大文件来说 IO 和内存开销极大。
2. **编码检测**（`EncodingDetector`）：虽然编码检测只需要前 8KB 数据，但 `FileLoader` 传入的是整个文件的字节数组，导致先完成完整文件读取才能开始编码检测。
3. **分页计算**（`TextPaginator`）：对全文循环分页，每次迭代都使用 `text.substring(currentOffset)` 创建剩余文本的副本，并为整个剩余文本创建 `StaticLayout`，时间复杂度为 O(n²)，对大文本极其低效。
4. **加载体验**：加载期间仅显示一个 `CircularProgressIndicator`，没有进度提示，用户无法感知加载进度和预计时间。

本需求文档旨在定义一系列优化措施，在不改变现有功能的前提下，显著提升大文件的加载速度和用户体验。

## 需求

### 需求 1：优化文件读取流程

**用户故事：** 作为一名阅读者，我希望打开大文件时能更快地开始阅读，以便减少等待时间。

#### 验收标准

1. WHEN 用户打开一个文本文件 THEN 系统 SHALL 先读取文件前 8KB 数据进行编码检测，而不是读取整个文件后再检测编码。
2. WHEN 编码检测完成后 THEN 系统 SHALL 使用检测到的编码，通过流式方式（`BufferedReader`）读取文件内容，避免一次性将整个文件的字节数组加载到内存中。
3. WHEN 文件大小超过一定阈值（如 1MB）THEN 系统 SHALL 采用分块读取策略，将文件内容分批读入，降低内存峰值占用。

### 需求 2：优化分页计算性能

**用户故事：** 作为一名阅读者，我希望大文件的分页计算能在合理时间内完成，以便快速翻页和跳转。

#### 验收标准

1. WHEN 系统对文本进行分页时 THEN 系统 SHALL 避免在每次迭代中对剩余文本调用 `substring`，而应使用基于偏移量的方式（如 `StaticLayout.Builder.obtain(text, start, end, ...)`）直接在原始文本上操作。
2. WHEN 系统创建 `StaticLayout` 进行行测量时 THEN 系统 SHALL 仅传入当前需要测量的文本范围（从当前偏移量开始，取一个合理的预估窗口长度），而不是传入全部剩余文本。
3. WHEN 分页计算完成后 THEN 系统 SHALL 产出的分页结果与优化前在逻辑上保持一致（同样的文本、字体、页面尺寸下，分页位置应相同或近似）。

### 需求 3：实现渐进式加载体验

**用户故事：** 作为一名阅读者，我希望在大文件加载过程中能看到进度信息，以便了解加载进展而不会以为应用卡死。

#### 验收标准

1. WHEN 用户打开大文件（文件大小 > 1MB）且加载尚未完成 THEN 系统 SHALL 展示加载进度百分比或提示信息（如"正在加载... 50%"）。
2. WHEN 文件内容读取完成但分页计算尚未完成 THEN 系统 SHALL 展示"正在排版..."等提示信息，让用户知道系统仍在处理。
3. IF 加载过程中出现错误（如文件损坏、编码识别失败）THEN 系统 SHALL 显示明确的错误信息，并提供返回操作。

### 需求 4：优化内存使用

**用户故事：** 作为一名阅读者，我希望阅读大文件时应用不会因内存不足而崩溃，以便可以顺畅地阅读任何大小的文件。

#### 验收标准

1. WHEN 系统加载文件内容时 THEN 系统 SHALL 避免同时持有原始字节数组和解码后的字符串两份数据，应在编码检测完成后尽快释放原始字节数组。
2. WHEN 系统完成文件读取后 THEN 系统 SHALL 仅在内存中保留解码后的文本字符串和分页索引，不保留原始字节数据。
3. IF 文件大小超过可用内存的安全阈值 THEN 系统 SHALL 给出提示信息（如"文件过大，可能影响阅读体验"），而不是直接崩溃。

### 需求 5：保持功能兼容性

**用户故事：** 作为一名阅读者，我希望优化后的加载流程不会影响现有的阅读功能，以便原有体验不受损失。

#### 验收标准

1. WHEN 文件加载完成后 THEN 系统 SHALL 仍能正确恢复上次的阅读位置（字符偏移量）。
2. WHEN 文件加载完成后 THEN 系统 SHALL 仍能正确执行全文搜索功能（`TextSearchEngine`）。
3. WHEN 文件加载完成后 THEN 系统 SHALL 仍能正确解析目录结构（`TocParser`）。
4. WHEN 用户修改字体大小或行间距等设置后 THEN 系统 SHALL 仍能正确触发重新分页，并保持当前阅读位置。
5. WHEN 系统加载不同编码的文件（UTF-8、GBK、GB18030、Big5、UTF-16 等）THEN 系统 SHALL 仍能正确识别编码并显示文本，与优化前行为一致。
